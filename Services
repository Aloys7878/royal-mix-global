// services/lambda/cloudinary-sign.js
const crypto = require('crypto');

exports.handler = async (event) => {
  try {
    const timestamp = Math.floor(Date.now() / 1000);
    const preset = process.env.CLOUDINARY_UPLOAD_PRESET || 'Royalmix-global';
    const apiSecret = process.env.CLOUDINARY_API_SECRET; // set in Lambda env

    // sign upload_preset + timestamp
    const toSign = `timestamp=${timestamp}&upload_preset=${preset}`;
    const signature = crypto.createHash('sha1').update(toSign + apiSecret).digest('hex');

    return {
      statusCode: 200,
      headers: { 'Access-Control-Allow-Origin': '*', 'Content-Type': 'application/json' },
      body: JSON.stringify({
        timestamp,
        signature,
        api_key: process.env.CLOUDINARY_API_KEY,
        cloud_name: process.env.CLOUDINARY_CLOUD_NAME,
        upload_preset: preset
      })
    };
  } catch (err) {
    return { statusCode: 500, body: JSON.stringify({ error: err.message }) };
  }
};
